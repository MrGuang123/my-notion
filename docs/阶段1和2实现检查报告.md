# é˜¶æ®µ1å’Œé˜¶æ®µ2åŠŸèƒ½å®ç°æ£€æŸ¥æŠ¥å‘Š

## ğŸ“‹ æ€»ä½“è¯„ä¼°

**é˜¶æ®µ1ï¼ˆè´¦å·ä¸ç§Ÿæˆ·ï¼‰**: âœ… åŸºæœ¬å®Œæˆï¼Œå­˜åœ¨1ä¸ªBugå’Œæµ‹è¯•ç¼ºå¤±  
**é˜¶æ®µ2ï¼ˆæ–‡æ¡£ä¸è¯„è®ºï¼‰**: âœ… å·²å®Œæˆï¼Œæµ‹è¯•ç¼ºå¤±

---

## ğŸ” é˜¶æ®µ1ï¼šè´¦å·ä¸ç§Ÿæˆ· - è¯¦ç»†æ£€æŸ¥

### âœ… å®ä½“è®¾è®¡ï¼ˆå·²å®Œæˆï¼‰

| å®ä½“ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| `users` | âœ… | åŒ…å« id, email(unique), password_hash, name, created_at, updated_at |
| `tenants` | âœ… | åŒ…å« id, name, created_at |
| `memberships` | âœ… | åŒ…å« id, user_id, tenant_id, role(enum: owner/admin/member), created_at |
| `refresh_tokens` | âœ… | åŒ…å« id, user_id, token(hash), expires_at, created_at |

**å®ç°ä½ç½®**:
- `src/modules/users/entities/user.entity.ts`
- `src/modules/tenants/entities/tenant.entity.ts`
- `src/modules/tenants/entities/membership.entity.ts`
- `src/modules/auth/entities/refresh-token.entity.ts`

### âœ… DTO/æ ¡éªŒï¼ˆå·²å®Œæˆï¼‰

| DTO | çŠ¶æ€ | æ ¡éªŒè§„åˆ™ |
|-----|------|----------|
| RegisterDto | âœ… | emailæ ¼å¼ã€å¯†ç 8-64å­—ç¬¦ã€nameå¿…å¡«ã€tenantNameå¿…å¡« |
| LoginDto | âœ… | emailæ ¼å¼ã€å¯†ç 8-64å­—ç¬¦ |
| CreateTenantDto | âœ… | nameå¿…å¡«ã€æœ€å¤§120å­—ç¬¦ |

**å®ç°ä½ç½®**:
- `src/modules/auth/dtos/register.dto.ts`
- `src/modules/auth/dtos/login.dto.ts`
- `src/modules/tenants/dtos/create-tenant.dto.ts`

### âš ï¸ ä¸šåŠ¡è§„åˆ™ï¼ˆåŸºæœ¬å®Œæˆï¼Œæœ‰1ä¸ªBugï¼‰

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| æ³¨å†Œ | âš ï¸ **æœ‰Bug** | âœ… åˆ›å»º user + tenant + membership(owner) åœ¨äº‹åŠ¡ä¸­<br>âŒ **Bug**: `auth.service.ts:41` åº”è¯¥æ˜¯ `if (existing)` è€Œä¸æ˜¯ `if (!existing)` |
| ç™»å½• | âœ… | ä½¿ç”¨ argon2id æ ¡éªŒå¯†ç ï¼Œç­¾å‘ access/refresh token |
| åˆ·æ–° | âœ… | æ ¡éªŒ refresh tokenï¼Œé‡æ–°ç­¾å‘ access token |
| é‰´æƒ | âœ… | JWTå®ˆå« + Tenantå®ˆå«ï¼Œæ ¡éªŒ membership å’Œè§’è‰² |

**Bug è¯¦æƒ…**:
```typescript
// æ–‡ä»¶: src/modules/auth/auth.service.ts, ç¬¬41è¡Œ
// å½“å‰ä»£ç ï¼ˆé”™è¯¯ï¼‰:
if (!existing) throw new ConflictException('Email already in use');

// åº”è¯¥æ”¹ä¸º:
if (existing) throw new ConflictException('Email already in use');
```

**å®ç°ä½ç½®**:
- `src/modules/auth/auth.service.ts` - æ ¸å¿ƒè®¤è¯é€»è¾‘
- `src/common/guards/tenant.guard.ts` - ç§Ÿæˆ·å®ˆå«
- `src/common/guards/roles.guard.ts` - è§’è‰²å®ˆå«
- `src/modules/auth/jwt-auth.guard.ts` - JWTå®ˆå«
- `src/modules/auth/jwt.strategy.ts` - JWTç­–ç•¥

### âœ… æ¥å£å®ç°ï¼ˆå·²å®Œæˆï¼‰

| æ¥å£ | çŠ¶æ€ | å®ç°ä½ç½® |
|------|------|----------|
| POST /api/auth/register | âœ… | AuthController.register |
| POST /api/auth/login | âœ… | AuthController.login |
| POST /api/auth/refresh | âœ… | AuthController.refresh |
| GET /api/me | âœ… | UsersController.me |
| POST /api/tenants | âœ… | TenantsController.create |
| GET /api/tenants/:id/members | âœ… | TenantsController.listMembersï¼ˆéœ€owner/adminè§’è‰²ï¼‰ |
| POST /api/tenants/:id/members | âœ… | TenantsController.upsertMemberï¼ˆæ·»åŠ æˆå‘˜/è§’è‰²å˜æ›´ï¼‰ |

### âŒ æµ‹è¯•ï¼ˆç¼ºå¤±ï¼‰

| æµ‹è¯•ç±»å‹ | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| AuthService å•å…ƒæµ‹è¯• | âŒ | éœ€è¦æµ‹è¯•ï¼šhash/compareã€tokenè¿‡æœŸã€æ³¨å†Œ/ç™»å½•é€»è¾‘ |
| TenantGuard å•å…ƒæµ‹è¯• | âŒ | éœ€è¦æµ‹è¯•ï¼šç§Ÿæˆ·æ ¡éªŒã€membershipæ ¡éªŒã€è·¨ç§Ÿæˆ·è®¿é—®æ‹’ç» |
| e2e æµ‹è¯• | âŒ | éœ€è¦æµ‹è¯•ï¼šæ³¨å†Œâ†’ç™»å½•â†’è®¿é—®/meï¼Œè·¨ç§Ÿæˆ·è®¿é—®åº”æ‹’ç» |

**å½“å‰çŠ¶æ€**: åªæœ‰ä¸€ä¸ªåŸºç¡€çš„ `test/app.e2e-spec.ts`ï¼Œä»…æµ‹è¯•æ ¹è·¯å¾„ã€‚

---

## ğŸ” é˜¶æ®µ2ï¼šæ–‡æ¡£ä¸è¯„è®º - è¯¦ç»†æ£€æŸ¥

### âœ… å®ä½“è®¾è®¡ï¼ˆå·²å®Œæˆï¼‰

| å®ä½“ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| `documents` | âœ… | åŒ…å« id, tenant_id, title, content(jsonb), version(int), created_by, updated_by, created_at, updated_at |
| `comments` | âœ… | åŒ…å« id, doc_id, tenant_id, user_id, body, created_at |

**å®ç°äº®ç‚¹**:
- âœ… ä½¿ç”¨ `@VersionColumn()` å®ç°ä¹è§‚é”
- âœ… content å­—æ®µä½¿ç”¨ jsonb å­˜å‚¨ï¼Œæ”¯æŒç»“æ„åŒ–æ•°æ®

**å®ç°ä½ç½®**:
- `src/modules/documents/entities/document.entity.ts`
- `src/modules/documents/entities/comment.entity.ts`

### âœ… ä¸šåŠ¡è§„åˆ™ï¼ˆå·²å®Œæˆï¼‰

| åŠŸèƒ½ | çŠ¶æ€ | å®ç°ç»†èŠ‚ |
|------|------|----------|
| æ–‡æ¡£ CRUD | âœ… | åˆ›å»ºã€åˆ—è¡¨ã€è¯¦æƒ…ã€æ›´æ–°ã€åˆ é™¤ |
| ä¹è§‚é” | âœ… | æ›´æ–°æ—¶æ ¡éªŒ versionï¼Œå†²çªè¿”å› 409 ConflictException |
| åˆ—è¡¨ç¼“å­˜ | âœ… | Redisç¼“å­˜ï¼Œæ”¯æŒåˆ†é¡µï¼ŒTTL 120ç§’<br>âœ… ä½¿ç”¨ç‰ˆæœ¬å·ç­–ç•¥ï¼ˆ`doc:list:version:${tenantId}`ï¼‰<br>âœ… æ›´æ–°/åˆ é™¤åè‡ªåŠ¨å¤±æ•ˆï¼ˆbump versionï¼‰ |
| çƒ­é—¨æ–‡æ¡£ | âœ… | æŒ‰è¯„è®ºæ•°æ’åºï¼ˆsort=hotï¼‰ï¼Œæ”¯æŒç¼“å­˜ |
| è¯„è®ºåˆ†é¡µ | âœ… | æŒ‰åˆ›å»ºæ—¶é—´å€’åºï¼Œæ”¯æŒ page/pageSize |
| è¯„è®ºé™é€Ÿ | âœ… | ä½¿ç”¨ Redis + INCR å®ç°<br>é»˜è®¤ï¼š10æ¡/60ç§’ï¼ˆå¯é…ç½®ï¼‰<br>ç»´åº¦ï¼štenant + doc + user<br>è¶…é™è¿”å› 429 |

**å®ç°äº®ç‚¹**:
- âœ… ç¼“å­˜ç­–ç•¥ä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶ï¼Œé¿å…æ‰‹åŠ¨æ¸…ç†æ‰€æœ‰ç¼“å­˜key
- âœ… è¯„è®ºé™é€Ÿä½¿ç”¨ Redis åŸå­æ“ä½œï¼Œä¿è¯å¹¶å‘å®‰å…¨
- âœ… çƒ­é—¨æ–‡æ¡£ä½¿ç”¨ JOIN + GROUP BY + COUNT å®ç°

**å®ç°ä½ç½®**:
- `src/modules/documents/documents.service.ts` - æ–‡æ¡£æœåŠ¡ï¼ˆ134è¡Œä»£ç ï¼Œå«ç¼“å­˜é€»è¾‘ï¼‰
- `src/modules/documents/comments.service.ts` - è¯„è®ºæœåŠ¡ï¼ˆ122è¡Œä»£ç ï¼Œå«é™é€Ÿé€»è¾‘ï¼‰

### âœ… æ¥å£å®ç°ï¼ˆå·²å®Œæˆï¼‰

| æ¥å£ | çŠ¶æ€ | å®ç°ä½ç½® |
|------|------|----------|
| POST /api/docs | âœ… | DocumentsController.create |
| GET /api/docs | âœ… | DocumentsController.listï¼ˆæ”¯æŒåˆ†é¡µã€sort=hot/recentï¼‰ |
| GET /api/docs/:id | âœ… | DocumentsController.findOne |
| PUT /api/docs/:id | âœ… | DocumentsController.updateï¼ˆéœ€æä¾›versionï¼‰ |
| DELETE /api/docs/:id | âœ… | DocumentsController.remove |
| GET /api/docs/:id/comments | âœ… | CommentsController.listï¼ˆæ”¯æŒåˆ†é¡µï¼‰ |
| POST /api/docs/:id/comments | âœ… | CommentsController.createï¼ˆæœ‰é™é€Ÿï¼‰ |
| DELETE /api/comments/:id | âœ… | CommentsController.removeï¼ˆéœ€æœ¬äººï¼‰ |

**æ‰€æœ‰æ¥å£éƒ½å— TenantGuard ä¿æŠ¤ï¼Œç¡®ä¿ç§Ÿæˆ·éš”ç¦»ã€‚**

### âœ… DTO/æ ¡éªŒï¼ˆå·²å®Œæˆï¼‰

| DTO | çŠ¶æ€ | æ ¡éªŒè§„åˆ™ |
|-----|------|----------|
| CreateDocumentDto | âœ… | title(å¿…å¡«,â‰¤200), content(å¿…å¡«,object) |
| UpdateDocumentDto | âœ… | title(å¯é€‰,â‰¤200), content(å¯é€‰,object), version(å¿…å¡«,â‰¥1) |
| CreateCommentDto | âœ… | body(å¿…å¡«,text) |
| DocumentQueryDto | âœ… | page, pageSize, sort(hot/recent) |
| CommentQueryDto | âœ… | page, pageSize |

### âŒ æµ‹è¯•ï¼ˆç¼ºå¤±ï¼‰

| æµ‹è¯•ç±»å‹ | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| e2e æµ‹è¯• | âŒ | éœ€è¦æµ‹è¯•ï¼š<br>- åˆ›å»ºæ–‡æ¡£â†’æ›´æ–°ï¼ˆæ­£ç¡®versionï¼‰<br>- é”™è¯¯versionè¿”å›409<br>- è¯„è®ºåˆ†é¡µ<br>- è¯„è®ºé™é€Ÿï¼ˆè¶…è¿‡é˜ˆå€¼è¿”å›429ï¼‰<br>- ç¼“å­˜ï¼šæ›´æ–°/åˆ é™¤ååˆ—è¡¨å˜åŒ– |
| å•å…ƒæµ‹è¯• | âŒ | éœ€è¦æµ‹è¯•ï¼š<br>- DocumentsService ç¼“å­˜é€»è¾‘<br>- CommentsService é™é€Ÿé€»è¾‘ |

---

## ğŸ¯ å…¨å±€èƒ½åŠ›æ£€æŸ¥ï¼ˆé˜¶æ®µ0è¦æ±‚ï¼‰

### âœ… åŸºç¡€è®¾æ–½ï¼ˆå·²å®Œæˆï¼‰

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| å…¨å±€å‰ç¼€ | âœ… | `/api` |
| ç¯å¢ƒé…ç½® | âœ… | ä½¿ç”¨ `@nestjs/config` + Joi æ ¡éªŒ<br>æ ¡éªŒå­—æ®µï¼šDB_HOST/PORT/USER/PASS/DB_NAME/REDIS_URL/MEILI_HOST/MEILI_KEY/JWT_SECRET/JWT_REFRESH_SECRET |
| TypeORM | âœ… | Postgres + snake_case å‘½åç­–ç•¥ |
| å…¨å±€ç®¡é“ | âœ… | ValidationPipeï¼ˆwhitelist, transform, forbidNonWhitelistedï¼‰ |
| å¼‚å¸¸è¿‡æ»¤å™¨ | âœ… | ç»Ÿä¸€é”™è¯¯å“åº”ï¼ˆcode/message/errors/path/timestampï¼‰ |
| æ—¥å¿—æ‹¦æˆªå™¨ | âœ… | è®°å½• method/path/status/duration/req-id/tenant-id/user-id |
| JWTå®ˆå« | âœ… | å…¨å±€å¯ç”¨ï¼Œä½¿ç”¨ @Public() è£…é¥°å™¨è·³è¿‡ |
| Tenantå®ˆå« | âœ… | ä» header `x-tenant-id` è§£æï¼Œæ ¡éªŒ membership |
| Swagger | âœ… | è·¯å¾„ `/docs`ï¼Œé…ç½® Bearer auth |
| Helmet | âœ… | å®‰å…¨å¤´ |
| CORS | âœ… | å¯é…ç½®ç™½åå•ï¼ˆé»˜è®¤ localhost:3000ï¼‰ |
| RequestId | âœ… | ä¸­é—´ä»¶ç”Ÿæˆ/é€ä¼  |
| é™æµ | âœ… | ThrottlerModuleï¼ˆ60ç§’/100æ¬¡ï¼‰ |
| Cache | âœ… | Redisï¼ˆcache-manager-ioredis-yetï¼‰ï¼Œé»˜è®¤TTL 30ç§’ |
| é˜Ÿåˆ— | âœ… | BullMQï¼ˆæ³¨å†Œ default é˜Ÿåˆ—ï¼‰ |
| å¥åº·æ£€æŸ¥ | âœ… | `/health`ï¼ˆDB/Redis/Queue pingï¼‰ |

**å®ç°ä½ç½®**:
- `src/main.ts` - å…¨å±€é…ç½®
- `src/infra/infra.module.ts` - åŸºç¡€è®¾æ–½æ¨¡å—
- `src/common/` - å®ˆå«/æ‹¦æˆªå™¨/è¿‡æ»¤å™¨/ä¸­é—´ä»¶

---

## ğŸ“Š æ€»ç»“

### âœ… å·²å®Œæˆçš„åŠŸèƒ½

#### é˜¶æ®µ1ï¼ˆ7/8 âœ…ï¼‰
- âœ… å®ä½“è®¾è®¡å®Œæ•´
- âœ… DTOæ ¡éªŒå®Œæ•´
- âš ï¸ ä¸šåŠ¡è§„åˆ™åŸºæœ¬å®Œæˆï¼ˆæœ‰1ä¸ªBugï¼‰
- âœ… æ¥å£å®ç°å®Œæ•´
- âŒ æµ‹è¯•ç¼ºå¤±

#### é˜¶æ®µ2ï¼ˆ4/5 âœ…ï¼‰
- âœ… å®ä½“è®¾è®¡å®Œæ•´
- âœ… ä¸šåŠ¡è§„åˆ™å®Œæ•´ï¼ˆå«ç¼“å­˜/é™é€Ÿï¼‰
- âœ… æ¥å£å®ç°å®Œæ•´
- âœ… DTOæ ¡éªŒå®Œæ•´
- âŒ æµ‹è¯•ç¼ºå¤±

### ğŸ› éœ€è¦ä¿®å¤çš„é—®é¢˜

#### ğŸ”´ é«˜ä¼˜å…ˆçº§
1. **æ³¨å†Œé€»è¾‘Bug**ï¼ˆé˜¶æ®µ1ï¼‰
   - æ–‡ä»¶ï¼š`src/modules/auth/auth.service.ts:41`
   - é—®é¢˜ï¼šæ¡ä»¶åˆ¤æ–­åäº†
   - å½±å“ï¼šæ— æ³•æ­£å¸¸æ³¨å†Œï¼ˆä¼šæç¤ºé‚®ç®±å·²å­˜åœ¨ï¼Œå³ä½¿é‚®ç®±æ˜¯æ–°çš„ï¼‰

#### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§
2. **æµ‹è¯•ç¼ºå¤±**ï¼ˆé˜¶æ®µ1+2ï¼‰
   - ç¼ºå°‘ AuthServiceã€TenantGuard çš„å•å…ƒæµ‹è¯•
   - ç¼ºå°‘å®Œæ•´çš„ e2e æµ‹è¯•è¦†ç›–
   - ç¼ºå°‘ç¼“å­˜ã€é™é€Ÿçš„é›†æˆæµ‹è¯•

### âœ¨ å®ç°äº®ç‚¹

1. **ä¹è§‚é”**ï¼šä½¿ç”¨ TypeORM `@VersionColumn()` ä¼˜é›…å®ç°ç‰ˆæœ¬æ§åˆ¶
2. **ç¼“å­˜ç­–ç•¥**ï¼šä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶ï¼ˆ`doc:list:version:${tenantId}`ï¼‰ï¼Œé¿å…ç¼“å­˜keyçˆ†ç‚¸
3. **è¯„è®ºé™é€Ÿ**ï¼šä½¿ç”¨ Redis INCR + PEXPIRE å®ç°é«˜å¹¶å‘å®‰å…¨çš„å›ºå®šçª—å£é™æµ
4. **å®‰å…¨æ€§**ï¼šargon2id å¯†ç å“ˆå¸Œï¼ŒRefresh Token å­˜å‚¨hashè€Œéæ˜æ–‡
5. **ç§Ÿæˆ·éš”ç¦»**ï¼šæ‰€æœ‰æ•°æ®æ“ä½œéƒ½å¸¦ tenantIdï¼ŒTenantGuard ç¡®ä¿è·¨ç§Ÿæˆ·è®¿é—®è¢«æ‹’ç»
6. **ä»£ç ç»„ç»‡**ï¼šæ¨¡å—åŒ–æ¸…æ™°ï¼Œinfraå±‚ä¸ä¸šåŠ¡å±‚åˆ†ç¦»

### ğŸ“ å»ºè®®

1. **ç«‹å³ä¿®å¤**: ä¿®å¤æ³¨å†Œé€»è¾‘çš„Bugï¼ˆ1åˆ†é’Ÿä¿®å¤ï¼‰
2. **è¡¥å……æµ‹è¯•**: 
   - ç¼–å†™ AuthService å•å…ƒæµ‹è¯•ï¼ˆhashã€tokenã€æ³¨å†Œã€ç™»å½•ï¼‰
   - ç¼–å†™ TenantGuard å•å…ƒæµ‹è¯•ï¼ˆç§Ÿæˆ·éš”ç¦»ï¼‰
   - ç¼–å†™å®Œæ•´çš„ e2e æµ‹è¯•ï¼ˆæ³¨å†Œâ†’ç™»å½•â†’æ–‡æ¡£CRUDâ†’è¯„è®ºâ†’è·¨ç§Ÿæˆ·è®¿é—®æ‹’ç»ï¼‰
3. **å¯é€‰ä¼˜åŒ–**:
   - æ·»åŠ  refresh token çš„é»‘åå•æœºåˆ¶ï¼ˆç™»å‡ºæ—¶æ’¤é”€ï¼‰
   - è€ƒè™‘æ·»åŠ æ–‡æ¡£æ“ä½œçš„å®¡è®¡æ—¥å¿—ï¼ˆä¸ºé˜¶æ®µ5å‡†å¤‡ï¼‰
   - è€ƒè™‘æ·»åŠ æ›´ç»†ç²’åº¦çš„æ–‡æ¡£æƒé™ï¼ˆownerå¯ä»¥è®¾ç½®æ–‡æ¡£ä¸ºç§æœ‰/å…¬å¼€ï¼‰

---

## ğŸ‰ ç»“è®º

**é˜¶æ®µ1å’Œé˜¶æ®µ2çš„åŠŸèƒ½å·²åŸºæœ¬å®ç°å®Œæ•´**ï¼Œä»£ç è´¨é‡è¾ƒé«˜ï¼Œæ¶æ„æ¸…æ™°ã€‚

- âœ… **å®ä½“ã€DTOã€æ¥å£ã€ä¸šåŠ¡è§„åˆ™** å…¨éƒ¨åˆ°ä½
- âœ… **ç¼“å­˜ã€é™é€Ÿã€ç§Ÿæˆ·éš”ç¦»ã€å®‰å…¨** å®ç°å®Œå–„
- âš ï¸ **æœ‰1ä¸ªæ³¨å†ŒBug** éœ€è¦ç«‹å³ä¿®å¤
- âŒ **æµ‹è¯•è¦†ç›–ä¸è¶³** éœ€è¦è¡¥å……

ä¿®å¤æ³¨å†ŒBugåï¼Œé˜¶æ®µ1å’Œé˜¶æ®µ2å³å¯è§†ä¸º**å®Œæˆ**ï¼Œå¯ä»¥ç»§ç»­æ¨è¿›åˆ°é˜¶æ®µ3ï¼ˆä»»åŠ¡ä¸é€šçŸ¥ï¼‰ã€‚

---

**ç”Ÿæˆæ—¶é—´**: 2026-01-27  
**æ£€æŸ¥èŒƒå›´**: é˜¶æ®µ0ï¼ˆåŸºç¡€è®¾æ–½ï¼‰ã€é˜¶æ®µ1ï¼ˆè´¦å·ä¸ç§Ÿæˆ·ï¼‰ã€é˜¶æ®µ2ï¼ˆæ–‡æ¡£ä¸è¯„è®ºï¼‰
