# é˜¶æ®µ4ï¼šæ–‡ä»¶ä¸Šä¼ ä¸è®¿é—® - å®ç°è®¡åˆ’

## ğŸ“‹ æ¦‚è¿°

å®ç°åˆ†ç‰‡æ–‡ä»¶ä¸Šä¼ å’Œé‰´æƒè®¿é—®ç³»ç»Ÿï¼Œæ”¯æŒå¤§æ–‡ä»¶ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ã€æµå¼ä¸‹è½½ï¼Œä¸ºæ–‡æ¡£é™„ä»¶ã€ç”¨æˆ·å¤´åƒç­‰åœºæ™¯æä¾›æ–‡ä»¶å­˜å‚¨èƒ½åŠ›ã€‚

---

## ğŸ¯ å®ç°ç›®æ ‡

### æ ¸å¿ƒåŠŸèƒ½
1. **åˆ†ç‰‡ä¸Šä¼ **: æ”¯æŒå¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ ã€åˆå¹¶ã€æ–­ç‚¹ç»­ä¼ 
2. **å­˜å‚¨æŠ½è±¡**: å¯æ’æ‹”çš„å­˜å‚¨é€‚é…å™¨ï¼ˆæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ/S3/OSSï¼‰
3. **é‰´æƒè®¿é—®**: ç§Ÿæˆ·éš”ç¦»ã€ç­¾åURLã€Rangeè¯·æ±‚æ”¯æŒ
4. **æ–‡ä»¶ç®¡ç†**: æ–‡ä»¶çŠ¶æ€ç®¡ç†ã€MIMEæ ¡éªŒã€å¤§å°é™åˆ¶

### æŠ€æœ¯è¦ç‚¹
- å­˜å‚¨é€‚é…å™¨è®¾è®¡æ¨¡å¼ï¼ˆæ¥å£æŠ½è±¡ + å¤šå®ç°ï¼‰
- åˆ†ç‰‡ä¸Šä¼ çŠ¶æ€æœºï¼ˆuploading â†’ readyï¼‰
- æµå¼ä¸‹è½½ï¼ˆæ”¯æŒ Range å¤´ï¼‰
- æ–‡ä»¶ç­¾å URLï¼ˆHMAC + è¿‡æœŸæ—¶é—´ï¼‰
- MIME ç±»å‹æ ¡éªŒå’Œæ–‡ä»¶é­”æ•°éªŒè¯

---

## ğŸ“ ä»»åŠ¡æ¸…å•

### ç¬¬ä¸€æ­¥ï¼šè®¾è®¡å­˜å‚¨æŠ½è±¡å±‚

#### 1.1 å®šä¹‰å­˜å‚¨æ¥å£
**æ–‡ä»¶**: `src/modules/files/storage/storage.interface.ts`
- [ ] å®šä¹‰ `FileStorage` æ¥å£
  - `initUpload(filename, size, mime, tenantId)`: åˆå§‹åŒ–ä¸Šä¼ ä¼šè¯
  - `uploadChunk(uploadId, chunkIndex, buffer)`: ä¸Šä¼ åˆ†ç‰‡
  - `completeUpload(uploadId)`: åˆå¹¶åˆ†ç‰‡ï¼Œæ ‡è®°å®Œæˆ
  - `getStream(storagePath)`: è·å–æ–‡ä»¶è¯»å–æµ
  - `deleteFile(storagePath)`: åˆ é™¤æ–‡ä»¶
  - `getFileInfo(storagePath)`: è·å–æ–‡ä»¶å…ƒä¿¡æ¯

#### 1.2 å®ç°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿé€‚é…å™¨
**æ–‡ä»¶**: `src/modules/files/storage/local-storage.adapter.ts`
- [ ] å®ç° `LocalStorageAdapter` ç±»
  - ä½¿ç”¨ `fs.promises` è¿›è¡Œæ–‡ä»¶æ“ä½œ
  - åˆ†ç‰‡ä¸´æ—¶ç›®å½•ï¼š`uploads/temp/{uploadId}/`
  - æœ€ç»ˆå­˜å‚¨è·¯å¾„ï¼š`uploads/{tenantId}/{year}/{month}/{filename}`
  - å®ç°åˆ†ç‰‡åˆå¹¶é€»è¾‘ï¼ˆæŒ‰ chunkIndex é¡ºåºå†™å…¥ï¼‰

#### 1.3 åˆ›å»ºå­˜å‚¨é…ç½®
**æ–‡ä»¶**: `src/modules/files/storage/storage.config.ts`
- [ ] å®šä¹‰é…ç½®æ¥å£
  - storageType: 'local' | 's3' | 'oss'
  - localPath: string (æœ¬åœ°å­˜å‚¨è·¯å¾„)
  - maxFileSize: number (æœ€å¤§æ–‡ä»¶å¤§å°ï¼Œé»˜è®¤ 100MB)
  - allowedMimeTypes: string[] (å…è®¸çš„ MIME ç±»å‹)

**é¢„è®¡è€—æ—¶**: 30åˆ†é’Ÿ

---

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºæ–‡ä»¶æ¨¡å—å®ä½“å’ŒDTO

#### 2.1 åˆ›å»ºæ–‡ä»¶å®ä½“
**æ–‡ä»¶**: `src/modules/files/entities/file.entity.ts`
- [ ] å®šä¹‰ File å®ä½“
  - id (uuid, ä¸»é”®)
  - tenantId (string)
  - filename (string, åŸå§‹æ–‡ä»¶å)
  - size (number, å­—èŠ‚æ•°)
  - mime (string, MIMEç±»å‹)
  - status (enum: uploading/ready/failed)
  - storagePath (string, å­˜å‚¨è·¯å¾„)
  - uploadId (string, ä¸Šä¼ ä¼šè¯ID, nullable)
  - totalChunks (number, æ€»åˆ†ç‰‡æ•°, nullable)
  - uploadedChunks (number, å·²ä¸Šä¼ åˆ†ç‰‡æ•°, nullable)
  - createdBy (string, nullable)
  - createdAt (timestamp)
  - updatedAt (timestamp)

#### 2.2 åˆ›å»ºæ–‡ä»¶çŠ¶æ€æšä¸¾
**æ–‡ä»¶**: `src/modules/files/file-status.enum.ts`
- [ ] å®šä¹‰ FileStatus enum (uploading, ready, failed)

#### 2.3 åˆ›å»ºæ–‡ä»¶DTO
**æ–‡ä»¶**: `src/modules/files/dtos/init-upload.dto.ts`
- [ ] filename: string (å¿…å¡«, åŸå§‹æ–‡ä»¶å)
- [ ] size: number (å¿…å¡«, æ–‡ä»¶å¤§å°)
- [ ] mime: string (å¿…å¡«, MIMEç±»å‹)
- [ ] totalChunks?: number (å¯é€‰, æ€»åˆ†ç‰‡æ•°)

**æ–‡ä»¶**: `src/modules/files/dtos/upload-chunk.dto.ts`
- [ ] chunkIndex: number (å¿…å¡«, åˆ†ç‰‡ç´¢å¼•, ä»0å¼€å§‹)
- [ ] md5?: string (å¯é€‰, åˆ†ç‰‡MD5æ ¡éªŒ)

**æ–‡ä»¶**: `src/modules/files/dtos/file-query.dto.ts`
- [ ] page?: number (é»˜è®¤ 1)
- [ ] pageSize?: number (é»˜è®¤ 20)
- [ ] status?: FileStatus (å¯é€‰, è¿‡æ»¤çŠ¶æ€)
- [ ] createdBy?: string (å¯é€‰, è¿‡æ»¤ä¸Šä¼ è€…)

**é¢„è®¡è€—æ—¶**: 20åˆ†é’Ÿ

---

### ç¬¬ä¸‰æ­¥ï¼šå®ç°æ–‡ä»¶æœåŠ¡

#### 3.1 åˆ›å»ºæ–‡ä»¶æœåŠ¡
**æ–‡ä»¶**: `src/modules/files/files.service.ts`
- [ ] `initUpload(tenantId, userId, dto)`: åˆå§‹åŒ–ä¸Šä¼ 
  - æ ¡éªŒæ–‡ä»¶å¤§å°ï¼ˆä¸è¶…è¿‡ maxFileSizeï¼‰
  - æ ¡éªŒ MIME ç±»å‹ï¼ˆåœ¨ç™½åå•å†…ï¼‰
  - ç”Ÿæˆ uploadId (uuid)
  - åˆ›å»º File è®°å½•ï¼ˆstatus: uploadingï¼‰
  - è°ƒç”¨ storage.initUpload()
  - è¿”å› uploadId å’Œ fileId

- [ ] `uploadChunk(tenantId, fileId, chunkIndex, buffer)`: ä¸Šä¼ åˆ†ç‰‡
  - æŸ¥è¯¢æ–‡ä»¶è®°å½•ï¼ˆæ ¡éªŒ status = uploadingï¼‰
  - æ ¡éªŒç§Ÿæˆ·æƒé™
  - è°ƒç”¨ storage.uploadChunk()
  - æ›´æ–° uploadedChunks è®¡æ•°
  - å¯é€‰ï¼šæ ¡éªŒåˆ†ç‰‡ MD5

- [ ] `completeUpload(tenantId, fileId)`: å®Œæˆä¸Šä¼ 
  - æŸ¥è¯¢æ–‡ä»¶è®°å½•
  - æ ¡éªŒæ‰€æœ‰åˆ†ç‰‡å·²ä¸Šä¼ 
  - è°ƒç”¨ storage.completeUpload()
  - æ›´æ–° status = ready
  - è¿”å›æ–‡ä»¶ä¿¡æ¯

- [ ] `getFile(tenantId, fileId)`: è·å–æ–‡ä»¶ä¿¡æ¯
  - æ ¡éªŒç§Ÿæˆ·æƒé™
  - è¿”å›æ–‡ä»¶å…ƒä¿¡æ¯

- [ ] `download(tenantId, fileId, range?)`: ä¸‹è½½æ–‡ä»¶
  - æ ¡éªŒç§Ÿæˆ·æƒé™å’Œ status = ready
  - è°ƒç”¨ storage.getStream()
  - æ”¯æŒ Range è¯·æ±‚ï¼ˆéƒ¨åˆ†ä¸‹è½½ï¼‰
  - è¿”å› ReadableStream

- [ ] `generateSignedUrl(tenantId, fileId, expiresIn)`: ç”Ÿæˆç­¾åURL
  - ç”Ÿæˆç­¾åï¼šHMAC(fileId + tenantId + expiresAt, secret)
  - è¿”å›ç­¾åURLï¼š`/files/{fileId}?signature={sig}&expires={ts}`

- [ ] `verifySignature(fileId, signature, expires)`: æ ¡éªŒç­¾å
  - æ ¡éªŒè¿‡æœŸæ—¶é—´
  - é‡æ–°è®¡ç®—ç­¾åå¹¶å¯¹æ¯”
  - è¿”å› boolean

- [ ] `list(tenantId, query)`: æŸ¥è¯¢æ–‡ä»¶åˆ—è¡¨
  - æ”¯æŒåˆ†é¡µ
  - æ”¯æŒæŒ‰ status/createdBy è¿‡æ»¤

- [ ] `remove(tenantId, fileId)`: åˆ é™¤æ–‡ä»¶
  - æ ¡éªŒç§Ÿæˆ·æƒé™
  - è°ƒç”¨ storage.deleteFile()
  - åˆ é™¤æ•°æ®åº“è®°å½•

#### 3.2 MIME ç±»å‹å’Œé­”æ•°æ ¡éªŒ
**æ–‡ä»¶**: `src/modules/files/utils/file-validator.ts`
- [ ] `validateMime(mime, allowedTypes)`: æ ¡éªŒ MIME ç±»å‹
- [ ] `validateFileSignature(buffer, expectedMime)`: æ ¡éªŒæ–‡ä»¶é­”æ•°
  - PNG: `89 50 4E 47`
  - JPEG: `FF D8 FF`
  - PDF: `25 50 44 46`
  - ç­‰å¸¸è§æ ¼å¼

**é¢„è®¡è€—æ—¶**: 50åˆ†é’Ÿ

---

### ç¬¬å››æ­¥ï¼šå®ç°æ–‡ä»¶æ§åˆ¶å™¨

#### 4.1 æ–‡ä»¶æ§åˆ¶å™¨
**æ–‡ä»¶**: `src/modules/files/files.controller.ts`
- [ ] `POST /files/init` - åˆå§‹åŒ–ä¸Šä¼ 
  - è¯·æ±‚ä½“ï¼šInitUploadDto
  - è¿”å›ï¼š{ uploadId, fileId }
  - éœ€è¦ TenantGuard å’Œ JwtAuthGuard

- [ ] `POST /files/:id/chunk` - ä¸Šä¼ åˆ†ç‰‡
  - è·¯å¾„å‚æ•°ï¼šfileId
  - æŸ¥è¯¢å‚æ•°ï¼šchunkIndex (number)
  - è¯·æ±‚ä½“ï¼šmultipart/form-data (file) æˆ– binary
  - è¿”å›ï¼š{ uploaded: true, uploadedChunks, totalChunks }
  - éœ€è¦ TenantGuard å’Œ JwtAuthGuard
  - ä½¿ç”¨ `FileInterceptor()` æˆ– raw body

- [ ] `POST /files/:id/complete` - å®Œæˆä¸Šä¼ 
  - è·¯å¾„å‚æ•°ï¼šfileId
  - è¿”å›ï¼šå®Œæ•´çš„æ–‡ä»¶ä¿¡æ¯
  - éœ€è¦ TenantGuard å’Œ JwtAuthGuard

- [ ] `GET /files/:id` - ä¸‹è½½æ–‡ä»¶ï¼ˆæµå¼ï¼‰
  - è·¯å¾„å‚æ•°ï¼šfileId
  - æŸ¥è¯¢å‚æ•°ï¼šsignature?, expires? (ç­¾åURL)
  - å“åº”å¤´ï¼š
    - Content-Type: {mime}
    - Content-Length: {size}
    - Content-Disposition: attachment; filename="{filename}"
    - Accept-Ranges: bytes
  - æ”¯æŒ Range è¯·æ±‚ï¼ˆè¿”å› 206 Partial Contentï¼‰
  - éœ€è¦ TenantGuard æˆ–ç­¾åæ ¡éªŒ

- [ ] `GET /files/:id/info` - è·å–æ–‡ä»¶ä¿¡æ¯
  - è¿”å›ï¼šæ–‡ä»¶å…ƒä¿¡æ¯ï¼ˆä¸ä¸‹è½½å†…å®¹ï¼‰
  - éœ€è¦ TenantGuard å’Œ JwtAuthGuard

- [ ] `GET /files` - æŸ¥è¯¢æ–‡ä»¶åˆ—è¡¨
  - æŸ¥è¯¢å‚æ•°ï¼šFileQueryDto
  - è¿”å›ï¼šåˆ†é¡µåˆ—è¡¨
  - éœ€è¦ TenantGuard å’Œ JwtAuthGuard

- [ ] `DELETE /files/:id` - åˆ é™¤æ–‡ä»¶
  - éœ€è¦ TenantGuard å’Œ JwtAuthGuard

- [ ] `POST /files/:id/signed-url` - ç”Ÿæˆç­¾åURL
  - è¯·æ±‚ä½“ï¼š{ expiresIn: number } (ç§’æ•°ï¼Œé»˜è®¤ 3600)
  - è¿”å›ï¼š{ url: string, expiresAt: string }
  - éœ€è¦ TenantGuard å’Œ JwtAuthGuard

**é¢„è®¡è€—æ—¶**: 40åˆ†é’Ÿ

---

### ç¬¬äº”æ­¥ï¼šå®ç°åˆ†ç‰‡ä¸Šä¼ é€»è¾‘ç»†èŠ‚

#### 5.1 åˆ†ç‰‡ä¸Šä¼ çŠ¶æ€ç®¡ç†
**æ–‡ä»¶**: `src/modules/files/files.service.ts` (è¡¥å……)
- [ ] å®ç°åˆ†ç‰‡è¿½è¸ª
  - ä½¿ç”¨æ•°æ®åº“å­—æ®µ `uploadedChunks` è¿½è¸ªè¿›åº¦
  - æˆ–ä½¿ç”¨ Redis å­˜å‚¨åˆ†ç‰‡çŠ¶æ€ï¼š`upload:{uploadId}:chunks` (Set)
  - è®°å½•æ¯ä¸ªåˆ†ç‰‡çš„ä¸Šä¼ æ—¶é—´å’Œ MD5ï¼ˆå¯é€‰ï¼‰

#### 5.2 å¹¶å‘ä¸Šä¼ å¤„ç†
- [ ] å…è®¸å¤šä¸ªåˆ†ç‰‡å¹¶å‘ä¸Šä¼ 
- [ ] ä½¿ç”¨äº‹åŠ¡æˆ–åŸå­æ“ä½œæ›´æ–° uploadedChunks
- [ ] é˜²æ­¢é‡å¤ä¸Šä¼ åŒä¸€åˆ†ç‰‡ï¼ˆå¹‚ç­‰æ€§ï¼‰

#### 5.3 è¶…æ—¶å’Œæ¸…ç†
**æ–‡ä»¶**: `src/modules/files/jobs/cleanup.job.ts`
- [ ] å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å°æ—¶æ‰§è¡Œï¼‰
  - æ¸…ç†è¶…è¿‡24å°æ—¶æœªå®Œæˆçš„ä¸Šä¼ ï¼ˆstatus = uploadingï¼‰
  - åˆ é™¤ä¸´æ—¶åˆ†ç‰‡æ–‡ä»¶
  - æ›´æ–°æ•°æ®åº“ status = failed

**é¢„è®¡è€—æ—¶**: 30åˆ†é’Ÿ

---

### ç¬¬å…­æ­¥ï¼šå®ç° Range è¯·æ±‚æ”¯æŒ

#### 6.1 Range è¯·æ±‚å¤„ç†
**æ–‡ä»¶**: `src/modules/files/files.controller.ts` (è¡¥å……)
- [ ] è§£æ `Range` è¯·æ±‚å¤´
  - æ ¼å¼ï¼š`bytes=start-end`
  - ä¾‹å¦‚ï¼š`bytes=0-1023` (å‰1KB)
  - ä¾‹å¦‚ï¼š`bytes=1024-` (ä»1KBåˆ°ç»“æŸ)

- [ ] è¿”å› 206 çŠ¶æ€ç å’Œéƒ¨åˆ†å†…å®¹
  - è®¾ç½®å“åº”å¤´ï¼š
    - `Content-Range: bytes {start}-{end}/{total}`
    - `Content-Length: {length}`
    - `Accept-Ranges: bytes`

- [ ] æµå¼è¯»å–éƒ¨åˆ†æ–‡ä»¶
  - ä½¿ç”¨ `fs.createReadStream(path, { start, end })`

**é¢„è®¡è€—æ—¶**: 20åˆ†é’Ÿ

---

### ç¬¬ä¸ƒæ­¥ï¼šåˆ›å»ºæ¨¡å—å¹¶æ³¨å†Œ

#### 7.1 æ–‡ä»¶æ¨¡å—
**æ–‡ä»¶**: `src/modules/files/files.module.ts`
- [ ] å¯¼å…¥ TypeOrmModule.forFeature([File])
- [ ] æ³¨å†Œå­˜å‚¨æä¾›è€…
  ```typescript
  {
    provide: 'FILE_STORAGE',
    useFactory: (config: ConfigService) => {
      const type = config.get('STORAGE_TYPE', 'local');
      if (type === 'local') {
        return new LocalStorageAdapter(config);
      }
      // æœªæ¥å¯æ‰©å±• S3Adapter, OSSAdapter
      throw new Error(`Unknown storage type: ${type}`);
    },
    inject: [ConfigService],
  }
  ```
- [ ] æ³¨å†Œ FilesService, FilesController
- [ ] å¯¼å‡º FilesService

#### 7.2 åœ¨ AppModule ä¸­æ³¨å†Œ
**æ–‡ä»¶**: `src/app.module.ts`
- [ ] å¯¼å…¥ FilesModule

#### 7.3 ç¯å¢ƒå˜é‡é…ç½®
**æ–‡ä»¶**: `.env.development`
- [ ] æ·»åŠ é…ç½®ï¼š
  ```env
  STORAGE_TYPE=local
  STORAGE_LOCAL_PATH=./uploads
  FILE_MAX_SIZE=104857600  # 100MB
  FILE_ALLOWED_MIMES=image/jpeg,image/png,image/gif,application/pdf,text/plain
  FILE_SIGNATURE_SECRET=your-hmac-secret-key
  ```

**é¢„è®¡è€—æ—¶**: 25åˆ†é’Ÿ

---

### ç¬¬å…«æ­¥ï¼šç¼–å†™æµ‹è¯•ï¼ˆå¯é€‰ï¼‰

#### 8.1 å•å…ƒæµ‹è¯•
**æ–‡ä»¶**: `src/modules/files/files.service.spec.ts`
- [ ] æµ‹è¯•åˆå§‹åŒ–ä¸Šä¼ 
- [ ] æµ‹è¯•åˆ†ç‰‡ä¸Šä¼ 
- [ ] æµ‹è¯•åˆå¹¶å®Œæˆ
- [ ] æµ‹è¯•ç­¾åç”Ÿæˆå’Œæ ¡éªŒ

**æ–‡ä»¶**: `src/modules/files/storage/local-storage.adapter.spec.ts`
- [ ] æµ‹è¯•æœ¬åœ°å­˜å‚¨é€‚é…å™¨

#### 8.2 e2e æµ‹è¯•
**æ–‡ä»¶**: `test/files.e2e-spec.ts`
- [ ] æµ‹è¯•å®Œæ•´ä¸Šä¼ æµç¨‹ï¼š
  - åˆå§‹åŒ– â†’ ä¸Šä¼ 3ä¸ªåˆ†ç‰‡ â†’ å®Œæˆ â†’ ä¸‹è½½
- [ ] æµ‹è¯• Range è¯·æ±‚ï¼ˆéƒ¨åˆ†ä¸‹è½½ï¼‰
- [ ] æµ‹è¯•ç­¾å URL
- [ ] æµ‹è¯•è¶Šæƒè®¿é—®æ‹’ç»ï¼ˆè·¨ç§Ÿæˆ·ï¼‰
- [ ] æµ‹è¯•æ–‡ä»¶å¤§å°é™åˆ¶
- [ ] æµ‹è¯• MIME ç±»å‹é™åˆ¶

**é¢„è®¡è€—æ—¶**: 50åˆ†é’Ÿï¼ˆå¯åç½®ï¼‰

---

## ğŸ“‚ ç›®å½•ç»“æ„ï¼ˆæ–°å¢ï¼‰

```
src/modules/files/
â”œâ”€â”€ entities/
â”‚   â””â”€â”€ file.entity.ts
â”œâ”€â”€ dtos/
â”‚   â”œâ”€â”€ init-upload.dto.ts
â”‚   â”œâ”€â”€ upload-chunk.dto.ts
â”‚   â””â”€â”€ file-query.dto.ts
â”œâ”€â”€ storage/
â”‚   â”œâ”€â”€ storage.interface.ts
â”‚   â”œâ”€â”€ storage.config.ts
â”‚   â”œâ”€â”€ local-storage.adapter.ts
â”‚   â””â”€â”€ (æœªæ¥) s3-storage.adapter.ts
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ file-validator.ts
â”œâ”€â”€ jobs/
â”‚   â””â”€â”€ cleanup.job.ts
â”œâ”€â”€ file-status.enum.ts
â”œâ”€â”€ files.controller.ts
â”œâ”€â”€ files.service.ts
â””â”€â”€ files.module.ts
```

---

## â±ï¸ é¢„è®¡æ€»è€—æ—¶

| ä»»åŠ¡ | è€—æ—¶ |
|------|------|
| è®¾è®¡å­˜å‚¨æŠ½è±¡å±‚ | 30 åˆ†é’Ÿ |
| åˆ›å»ºå®ä½“å’Œ DTO | 20 åˆ†é’Ÿ |
| å®ç°æ–‡ä»¶æœåŠ¡ | 50 åˆ†é’Ÿ |
| å®ç°æ§åˆ¶å™¨ | 40 åˆ†é’Ÿ |
| åˆ†ç‰‡ä¸Šä¼ é€»è¾‘ | 30 åˆ†é’Ÿ |
| Range è¯·æ±‚æ”¯æŒ | 20 åˆ†é’Ÿ |
| åˆ›å»ºæ¨¡å—å¹¶æ³¨å†Œ | 25 åˆ†é’Ÿ |
| **æ€»è®¡ï¼ˆä¸å«æµ‹è¯•ï¼‰** | **çº¦ 3.5 å°æ—¶** |
| ç¼–å†™æµ‹è¯•ï¼ˆå¯é€‰ï¼‰ | 50 åˆ†é’Ÿ |

---

## ğŸ”‘ å…³é”®æŠ€æœ¯ç‚¹

### 1. åˆ†ç‰‡ä¸Šä¼ æµç¨‹

```typescript
// å‰ç«¯ä»£ç ç¤ºä¾‹
async function uploadFile(file) {
  const CHUNK_SIZE = 1024 * 1024; // 1MB
  const totalChunks = Math.ceil(file.size / CHUNK_SIZE);

  // 1. åˆå§‹åŒ–ä¸Šä¼ 
  const { uploadId, fileId } = await fetch('/api/files/init', {
    method: 'POST',
    body: JSON.stringify({
      filename: file.name,
      size: file.size,
      mime: file.type,
      totalChunks,
    }),
  }).then(r => r.json());

  // 2. å¹¶å‘ä¸Šä¼ åˆ†ç‰‡
  const promises = [];
  for (let i = 0; i < totalChunks; i++) {
    const start = i * CHUNK_SIZE;
    const end = Math.min(start + CHUNK_SIZE, file.size);
    const chunk = file.slice(start, end);

    promises.push(
      fetch(`/api/files/${fileId}/chunk?chunkIndex=${i}`, {
        method: 'POST',
        body: chunk,
      })
    );
  }
  await Promise.all(promises);

  // 3. å®Œæˆä¸Šä¼ 
  const result = await fetch(`/api/files/${fileId}/complete`, {
    method: 'POST',
  }).then(r => r.json());

  return result;
}
```

### 2. æœ¬åœ°å­˜å‚¨é€‚é…å™¨å®ç°

```typescript
export class LocalStorageAdapter implements FileStorage {
  async uploadChunk(uploadId: string, chunkIndex: number, buffer: Buffer) {
    const chunkPath = path.join(
      this.tempDir,
      uploadId,
      `chunk-${chunkIndex}`
    );
    await fs.promises.mkdir(path.dirname(chunkPath), { recursive: true });
    await fs.promises.writeFile(chunkPath, buffer);
  }

  async completeUpload(uploadId: string) {
    const tempDir = path.join(this.tempDir, uploadId);
    const chunks = await fs.promises.readdir(tempDir);
    
    // æŒ‰é¡ºåºè¯»å–å¹¶åˆå¹¶åˆ†ç‰‡
    const writeStream = fs.createWriteStream(finalPath);
    for (const chunk of chunks.sort()) {
      const chunkPath = path.join(tempDir, chunk);
      const buffer = await fs.promises.readFile(chunkPath);
      writeStream.write(buffer);
    }
    writeStream.end();

    // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    await fs.promises.rm(tempDir, { recursive: true });
  }
}
```

### 3. Range è¯·æ±‚å¤„ç†

```typescript
@Get(':id')
async download(
  @Param('id') id: string,
  @Headers('range') range: string,
  @Res() res: Response,
) {
  const file = await this.filesService.getFile(tenantId, id);
  
  if (range) {
    // è§£æ Range å¤´ï¼šbytes=0-1023
    const [start, end] = this.parseRange(range, file.size);
    
    res.status(206); // Partial Content
    res.set({
      'Content-Range': `bytes ${start}-${end}/${file.size}`,
      'Content-Length': end - start + 1,
      'Accept-Ranges': 'bytes',
    });
    
    const stream = await this.filesService.downloadRange(
      tenantId, id, start, end
    );
    stream.pipe(res);
  } else {
    // å®Œæ•´ä¸‹è½½
    res.set({
      'Content-Type': file.mime,
      'Content-Length': file.size,
      'Content-Disposition': `attachment; filename="${file.filename}"`,
    });
    
    const stream = await this.filesService.download(tenantId, id);
    stream.pipe(res);
  }
}
```

### 4. ç­¾å URL ç”Ÿæˆ

```typescript
generateSignedUrl(fileId: string, expiresIn: number = 3600) {
  const expiresAt = Date.now() + expiresIn * 1000;
  const data = `${fileId}:${expiresAt}`;
  const signature = crypto
    .createHmac('sha256', this.signatureSecret)
    .update(data)
    .digest('hex');
  
  return {
    url: `/api/files/${fileId}?signature=${signature}&expires=${expiresAt}`,
    expiresAt: new Date(expiresAt).toISOString(),
  };
}

verifySignature(fileId: string, signature: string, expires: number) {
  if (Date.now() > expires) {
    return false; // å·²è¿‡æœŸ
  }
  
  const data = `${fileId}:${expires}`;
  const expectedSignature = crypto
    .createHmac('sha256', this.signatureSecret)
    .update(data)
    .digest('hex');
  
  return signature === expectedSignature;
}
```

### 5. æ–‡ä»¶é­”æ•°æ ¡éªŒ

```typescript
const FILE_SIGNATURES = {
  'image/png': [0x89, 0x50, 0x4E, 0x47],
  'image/jpeg': [0xFF, 0xD8, 0xFF],
  'application/pdf': [0x25, 0x50, 0x44, 0x46],
  'image/gif': [0x47, 0x49, 0x46],
};

function validateFileSignature(buffer: Buffer, mime: string): boolean {
  const signature = FILE_SIGNATURES[mime];
  if (!signature) return true; // æœªçŸ¥ç±»å‹ï¼Œè·³è¿‡æ ¡éªŒ
  
  for (let i = 0; i < signature.length; i++) {
    if (buffer[i] !== signature[i]) {
      return false;
    }
  }
  return true;
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å®‰å…¨æ€§
- âœ… **ç§Ÿæˆ·éš”ç¦»**ï¼šæ‰€æœ‰æ–‡ä»¶æ“ä½œéœ€è¦æ ¡éªŒ tenantId
- âœ… **ç­¾åURL**ï¼šé¿å…ç›´æ¥æš´éœ²æ–‡ä»¶è·¯å¾„ï¼Œä½¿ç”¨ç­¾åé˜²æ­¢è¶Šæƒè®¿é—®
- âœ… **MIMEæ ¡éªŒ**ï¼šé˜²æ­¢ä¸Šä¼ æ¶æ„æ–‡ä»¶ï¼ˆå¦‚ä¼ªè£…çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼‰
- âœ… **æ–‡ä»¶å¤§å°é™åˆ¶**ï¼šé˜²æ­¢ç£ç›˜ç©ºé—´è¢«è€—å°½
- âœ… **è·¯å¾„éå†æ”»å‡»**ï¼šsanitize æ–‡ä»¶åï¼Œç¦æ­¢ `../` ç­‰ç‰¹æ®Šå­—ç¬¦

### 2. æ€§èƒ½è€ƒè™‘
- âœ… **æµå¼å¤„ç†**ï¼šä½¿ç”¨ Stream è€Œéä¸€æ¬¡æ€§åŠ è½½åˆ°å†…å­˜
- âœ… **å¹¶å‘ä¸Šä¼ **ï¼šå…è®¸å¤šä¸ªåˆ†ç‰‡å¹¶å‘ä¸Šä¼ 
- âœ… **Range æ”¯æŒ**ï¼šå¤§æ–‡ä»¶å¯ä»¥åˆ†æ®µä¸‹è½½ï¼ŒèŠ‚çœå¸¦å®½
- âœ… **ä¸´æ—¶æ–‡ä»¶æ¸…ç†**ï¼šå®šæ—¶ä»»åŠ¡æ¸…ç†è¿‡æœŸçš„ä¸´æ—¶æ–‡ä»¶

### 3. å¯æ‰©å±•æ€§
- âœ… **å­˜å‚¨æŠ½è±¡**ï¼šæ¥å£è®¾è®¡å…è®¸è½»æ¾åˆ‡æ¢åˆ° S3/OSS/MinIO
- âœ… **åˆ†ç‰‡å¯é…ç½®**ï¼šå‰ç«¯å¯ä»¥æ ¹æ®ç½‘ç»œæƒ…å†µè°ƒæ•´åˆ†ç‰‡å¤§å°
- âœ… **å…ƒæ•°æ®æ‰©å±•**ï¼šå¯ä»¥æ·»åŠ ç¼©ç•¥å›¾ã€é¢„è§ˆå›¾ç­‰å­—æ®µ

### 4. å®¹é”™å¤„ç†
- âœ… **æ–­ç‚¹ç»­ä¼ **ï¼šå®¢æˆ·ç«¯å¯ä»¥æŸ¥è¯¢å·²ä¸Šä¼ çš„åˆ†ç‰‡ï¼Œè·³è¿‡é‡å¤ä¸Šä¼ 
- âœ… **å¹‚ç­‰æ€§**ï¼šåŒä¸€åˆ†ç‰‡é‡å¤ä¸Šä¼ ä¸ä¼šæŠ¥é”™
- âœ… **è¶…æ—¶å¤„ç†**ï¼š24å°æ—¶æœªå®Œæˆçš„ä¸Šä¼ è‡ªåŠ¨æ¸…ç†
- âœ… **ç£ç›˜æ»¡å¤„ç†**ï¼šæ•è·ç£ç›˜å†™å…¥é”™è¯¯ï¼Œè¿”å›å‹å¥½æç¤º

### 5. å¼€å‘ç¯å¢ƒ vs ç”Ÿäº§ç¯å¢ƒ
- **å¼€å‘ç¯å¢ƒ**ï¼šä½¿ç”¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ˆ`LocalStorageAdapter`ï¼‰
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šæ¨èä½¿ç”¨å¯¹è±¡å­˜å‚¨ï¼ˆS3/OSSï¼‰ï¼Œå…·æœ‰ï¼š
  - âœ… é«˜å¯ç”¨æ€§ï¼ˆå¤šå‰¯æœ¬ï¼‰
  - âœ… æ— é™æ‰©å±•æ€§
  - âœ… CDN åŠ é€Ÿ
  - âœ… æ›´ä½æˆæœ¬

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] å¯ä»¥åˆå§‹åŒ–ä¸Šä¼ ï¼Œè·å– uploadId
- [ ] å¯ä»¥ä¸Šä¼ å¤šä¸ªåˆ†ç‰‡ï¼Œæ”¯æŒå¹¶å‘
- [ ] å¯ä»¥å®Œæˆä¸Šä¼ ï¼Œæ–‡ä»¶çŠ¶æ€å˜ä¸º ready
- [ ] å¯ä»¥ä¸‹è½½æ–‡ä»¶ï¼ˆæµå¼ï¼Œæ”¯æŒå¤§æ–‡ä»¶ï¼‰
- [ ] å¯ä»¥ä½¿ç”¨ Range è¯·æ±‚ä¸‹è½½éƒ¨åˆ†æ–‡ä»¶
- [ ] å¯ä»¥ç”Ÿæˆç­¾å URLï¼Œåœ¨è¿‡æœŸæ—¶é—´å†…æœ‰æ•ˆ
- [ ] å¯ä»¥æŸ¥è¯¢æ–‡ä»¶åˆ—è¡¨ï¼Œæ”¯æŒè¿‡æ»¤
- [ ] å¯ä»¥åˆ é™¤æ–‡ä»¶ï¼ˆç‰©ç†åˆ é™¤ + æ•°æ®åº“è®°å½•ï¼‰
- [ ] è·¨ç§Ÿæˆ·è®¿é—®è¢«æ‹’ç»
- [ ] è¶…è¿‡å¤§å°é™åˆ¶çš„æ–‡ä»¶è¢«æ‹’ç»
- [ ] ä¸åœ¨ç™½åå•çš„ MIME ç±»å‹è¢«æ‹’ç»

### æŠ€æœ¯éªŒæ”¶
- [ ] å­˜å‚¨é€‚é…å™¨éµå¾ªæ¥å£çº¦å®š
- [ ] æœ¬åœ°å­˜å‚¨é€‚é…å™¨æ­£å¸¸å·¥ä½œ
- [ ] åˆ†ç‰‡æ–‡ä»¶æ­£ç¡®åˆå¹¶
- [ ] ä¸´æ—¶æ–‡ä»¶è¢«æ­£ç¡®æ¸…ç†
- [ ] æµå¼ä¸‹è½½ä¸å ç”¨è¿‡å¤šå†…å­˜
- [ ] Range è¯·æ±‚è¿”å›æ­£ç¡®çš„çŠ¶æ€ç å’Œå“åº”å¤´
- [ ] ç­¾åæ ¡éªŒé€»è¾‘æ­£ç¡®
- [ ] æ‰€æœ‰æ¥å£éµå¾ª RESTful è§„èŒƒ
- [ ] DTO æ ¡éªŒå®Œæ•´

### æµ‹è¯•éªŒæ”¶ï¼ˆå¯é€‰ï¼‰
- [ ] e2e æµ‹è¯•è¦†ç›–å®Œæ•´ä¸Šä¼ ä¸‹è½½æµç¨‹
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–å­˜å‚¨é€‚é…å™¨å’Œç­¾åé€»è¾‘
- [ ] æµ‹è¯•å¹¶å‘ä¸Šä¼ åœºæ™¯
- [ ] æµ‹è¯•æ–­ç‚¹ç»­ä¼ åœºæ™¯

---

## ğŸ“Œ å®æ–½é¡ºåº

**æ¨èæŒ‰ä»¥ä¸‹é¡ºåºå®æ–½**ï¼ˆæœ€å°åŒ–ä¾èµ–ï¼Œä¾¿äºå¢é‡éªŒè¯ï¼‰ï¼š

1. å®šä¹‰å­˜å‚¨æ¥å£ + é…ç½®ï¼ˆ10 åˆ†é’Ÿï¼‰
2. å®ç°æœ¬åœ°å­˜å‚¨é€‚é…å™¨ï¼ˆ20 åˆ†é’Ÿï¼‰â†’ å¯ä»¥å…ˆæµ‹è¯•æ–‡ä»¶è¯»å†™
3. åˆ›å»ºæ–‡ä»¶å®ä½“ + DTOï¼ˆ20 åˆ†é’Ÿï¼‰â†’ å¯ä»¥å…ˆæµ‹è¯•æ•°æ®åº“
4. å®ç°æ–‡ä»¶æœåŠ¡ï¼ˆåŸºç¡€ CRUDï¼Œ30 åˆ†é’Ÿï¼‰â†’ æµ‹è¯•ç®€å•ä¸Šä¼ ä¸‹è½½
5. å®ç°åˆ†ç‰‡ä¸Šä¼ é€»è¾‘ï¼ˆ30 åˆ†é’Ÿï¼‰â†’ æµ‹è¯•åˆ†ç‰‡ä¸Šä¼ 
6. å®ç°æ–‡ä»¶æ§åˆ¶å™¨ï¼ˆ40 åˆ†é’Ÿï¼‰â†’ æµ‹è¯•å®Œæ•´æµç¨‹
7. å®ç° Range è¯·æ±‚ï¼ˆ20 åˆ†é’Ÿï¼‰â†’ æµ‹è¯•éƒ¨åˆ†ä¸‹è½½
8. å®ç°ç­¾å URLï¼ˆ15 åˆ†é’Ÿï¼‰â†’ æµ‹è¯•å®‰å…¨è®¿é—®
9. å®ç°æ¸…ç†ä»»åŠ¡ï¼ˆ10 åˆ†é’Ÿï¼‰â†’ æµ‹è¯•è¶…æ—¶æ¸…ç†
10. è¡¥å……æµ‹è¯•ï¼ˆå¯é€‰ï¼Œ50 åˆ†é’Ÿï¼‰

---

## ğŸš€ æœªæ¥æ‰©å±•æ–¹å‘

### é˜¶æ®µ4+ï¼ˆå¯é€‰å¢å¼ºï¼‰

1. **å›¾ç‰‡å¤„ç†**
   - è‡ªåŠ¨ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆä½¿ç”¨ sharp åº“ï¼‰
   - æ”¯æŒå›¾ç‰‡è£å‰ªã€ç¼©æ”¾ã€æ°´å°
   - WebP æ ¼å¼è½¬æ¢ï¼ˆèŠ‚çœå¸¦å®½ï¼‰

2. **S3/OSS é€‚é…å™¨**
   - å®ç° `S3StorageAdapter`
   - æ”¯æŒé¢„ç­¾å URLï¼ˆS3 åŸç”ŸåŠŸèƒ½ï¼‰
   - æ”¯æŒ CDN åŠ é€Ÿ

3. **æ–­ç‚¹ç»­ä¼ å¢å¼º**
   - å‰ç«¯æŸ¥è¯¢å·²ä¸Šä¼ çš„åˆ†ç‰‡åˆ—è¡¨
   - åªä¸Šä¼ ç¼ºå¤±çš„åˆ†ç‰‡
   - æ”¯æŒæš‚åœ/æ¢å¤ä¸Šä¼ 

4. **æ–‡ä»¶ç‰ˆæœ¬ç®¡ç†**
   - åŒä¸€æ–‡ä»¶å¤šä¸ªç‰ˆæœ¬
   - ç‰ˆæœ¬å›æ»š
   - ç‰ˆæœ¬å¯¹æ¯”

5. **æ–‡ä»¶åˆ†äº«**
   - ç”Ÿæˆå…¬å¼€åˆ†äº«é“¾æ¥
   - è®¾ç½®è®¿é—®å¯†ç 
   - é™åˆ¶ä¸‹è½½æ¬¡æ•°

---

**å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…æ‚¨çš„ç¡®è®¤åå¼€å§‹å®æ–½ï¼** ğŸš€
